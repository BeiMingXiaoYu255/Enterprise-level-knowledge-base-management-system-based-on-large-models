<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="./black.ico" type="image/x-icon">
  <title>文档页面</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="base.css">
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
  <nav class="main-nav">
    <div class="nav-container">
      <div class="logo-container">
        <svg class="logo-icon" width="24" height="24" viewBox="0 0 24 24" fill="none"
          xmlns="http://www.w3.org/2000/svg">
          <path d="M21 5V19L12 14L3 19V5L12 10L21 5Z" fill="white" />
          <path
            d="M12 13C13.6569 13 15 11.6569 15 10C15 8.34315 13.6569 7 12 7C10.3431 7 9 8.34315 9 10C9 11.6569 10.3431 13 12 13Z"
            fill="#0078d4" />
        </svg>
        <span class="logo-text">知识库管理系统</span>
      </div>

      <div class="nav-item">
        <button class="dropdown-btn">
          <span>喵喵喵喵</span>
          <svg class="dropdown-icon" viewBox="0 0 12 12" width="12" height="12">
            <path d="M6 8L2 4h8z" fill="currentColor" />
          </svg>
        </button>
        <div class="dropdown-content">
          <div class="dropdown-layout">
            <div class="dropdown-left">
              <div class="dropdown-section">
                <h3 class="dropdown-title">喵喵喵喵</h3>
                <ul>
                  <li><a href="#">喵喵喵喵</a></li>
                  <li><a href="#">喵喵喵喵</a></li>
                  <li><a href="#">喵喵喵喵</a></li>
                </ul>
              </div>
              <div class="dropdown-section">
                <h3 class="dropdown-title">喵喵喵喵</h3>
                <ul>
                  <li><a href="#">喵喵喵喵</a></li>
                  <li><a href="#">喵喵喵喵</a></li>
                  <li><a href="#">喵喵喵喵</a></li>
                </ul>
              </div>
            </div>
            <div class="dropdown-explore">
              <div class="explore-title">知识库管理系统</div>
              <div class="explore-subtitle">Knowledge Base Management System</div>
              <a href="#" class="explore-link">探索所有使用功能</a>
              <div class="explore-image-container">
                <img src="./white.ico" alt="白底logo" class="explore-image">
              </div>
            </div>
          </div>
        </div>
      </div>


      <div class="nav-item">
        <button class="dropdown-btn">
          <span>喵喵喵喵</span>
          <svg class="dropdown-icon" viewBox="0 0 12 12" width="12" height="12">
            <path d="M6 8L2 4h8z" fill="currentColor" />
          </svg>
        </button>
        <div class="dropdown-content tools-dropdown">
          <div class="dropdown-layout">
            <div class="dropdown-left">
              <div class="dropdown-section">
                <ul>
                  <li><a href="#">喵喵喵喵</a></li>
                  <li><a href="#">喵喵喵喵</a></li>
                  <li><a href="#">喵喵喵喵</a></li>
                </ul>
              </div>
            </div>
            <div class="dropdown-explore">
              <div class="explore-title">知识库管理系统</div>
              <div class="explore-subtitle">Knowledge Base Management System</div>
              <a href="#" class="explore-link">探索所有使用功能</a>
              <div class="explore-image-container">
                <img src="./white.ico" alt="白底logo" class="explore-image">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- 专注模式容器 -->
  <div id="focusModeContainer" class="focus-mode-container">
    <div class="focus-content">
      <div id="focusContent" class="focus-text-area"></div>
      <button id="exitFocusModeBtn" class="exit-focus-btn">退出专注模式</button>
    </div>
  </div>
  <input type="file" id="fileInput" style="display:none">

  <!-- 设置选项框 - 增强版 -->
  <div id="settingsPanel" class="settings-panel">
    <!-- 顶部工具栏 -->
    <div class="settings-toolbar">
      <h3>偏好设置</h3>
      <div class="settings-toolbar-actions">
        <button class="help-btn tooltip">
          <i class="fas fa-question"></i>
          <span class="tooltip-text">查看各设置项的详细说明</span>
        </button>
        <button id="closeSettingsBtn" class="close-btn">×</button>
      </div>
    </div>

    <!-- 设置内容区 -->
    <div class="settings-content">
      <!-- 1. 显示设置分组 -->
      <div class="settings-group">
        <div class="settings-group-header" onclick="toggleGroup(this)">
          <span class="settings-group-title">显示设置</span>
          <span class="group-toggle"><i class="fas fa-chevron-right"></i></span>
        </div>
        <div class="settings-group-content">
          <div class="setting-item">
            <label>
              字体大小
              <span id="fontSizeValue">16px</span>
            </label>
            <input type="range" id="fontSize" min="12" max="24" step="1" value="16">
            <div class="item-desc">调整文档内容的字体显示大小</div>
          </div>
          <div class="setting-item">
            <label>
              行间距
              <span id="lineHeightValue">1.5</span>
            </label>
            <input type="range" id="lineHeight" min="1" max="3" step="0.1" value="1.5">
            <div class="item-desc">调整文本行与行之间的距离</div>
          </div>
          <div class="setting-item">
            <label>
              段间距
              <span id="paragraphSpacingValue">15px</span>
            </label>
            <input type="range" id="paragraphSpacing" min="0" max="30" step="1" value="15">
            <div class="item-desc">调整段落与段落之间的距离</div>
          </div>
          <div class="setting-item">
            <label>
              页边距
              <span id="marginSizeValue">20px</span>
            </label>
            <input type="range" id="marginSize" min="0" max="50" step="5" value="20">
            <div class="item-desc">调整文档内容区的四周边距</div>
          </div>
          <div class="setting-item">
            <label>
              字体选择
              <span id="fontFamilyValue">默认</span>
            </label>
            <select id="fontFamily" onchange="updateFontFamilyDisplay()">
              <option value="Arial, sans-serif, 'Segoe UI', 'Microsoft YaHei', sans-serif">默认字体</option>
              <option value="'Microsoft YaHei', sans-serif">微软雅黑</option>
              <option value="'SimSun', serif">宋体</option>
              <option value="'SimHei', sans-serif">黑体</option>
              <option value="'Courier New', monospace">等宽字体</option>
              <option value="'Times New Roman', serif">Times New Roman</option>
            </select>
            <div class="item-desc">选择文档内容的显示字体</div>
          </div>
          <div class="setting-item">
            <label>
              主题模式
              <label class="switch">
                <input type="checkbox" id="darkMode">
                <span class="slider"></span>
              </label>
            </label>
            <div class="item-desc">切换亮色/暗色主题（重启后生效）</div>
          </div>
        </div>
      </div>

      <!-- 2. 编辑器设置分组 -->
      <div class="settings-group">
        <div class="settings-group-header" onclick="toggleGroup(this)">
          <span class="settings-group-title">编辑器设置</span>
          <span class="group-toggle"><i class="fas fa-chevron-right"></i></span>
        </div>
        <div class="settings-group-content collapsed">
          <div class="setting-item">
            <label>
              自动保存
              <label class="switch">
                <input type="checkbox" id="autoSave" checked>
                <span class="slider"></span>
              </label>
            </label>
            <div class="item-desc">编辑时自动保存文档内容（每30秒）</div>
          </div>
          <div class="setting-item">
            <label>
              自动换行
              <label class="switch">
                <input type="checkbox" id="wordWrap" checked>
                <span class="slider"></span>
              </label>
            </label>
            <div class="item-desc">编辑器中超出宽度时自动换行</div>
          </div>
          <div class="setting-item">
            <label>
              显示行号
              <label class="switch">
                <input type="checkbox" id="showLineNumbers">
                <span class="slider"></span>
              </label>
            </label>
            <div class="item-desc">在编辑器左侧显示行号</div>
          </div>
          <div class="setting-item">
            <label>
              代码高亮
              <label class="switch">
                <input type="checkbox" id="codeHighlight" checked>
                <span class="slider"></span>
              </label>
            </label>
            <div class="item-desc">对Markdown中的代码块进行语法高亮</div>
          </div>
          <div class="setting-item">
            <label>
              自动缩进
              <span id="tabSizeValue">4</span>
            </label>
            <input type="range" id="tabSize" min="2" max="8" step="1" value="4">
            <div class="item-desc">设置编辑器中Tab键的缩进字符数</div>
          </div>
        </div>
      </div>

      <!-- 3. 导航与搜索设置分组 -->
      <div class="settings-group">
        <div class="settings-group-header" onclick="toggleGroup(this)">
          <span class="settings-group-title">导航与搜索</span>
          <span class="group-toggle"><i class="fas fa-chevron-right"></i></span>
        </div>
        <div class="settings-group-content collapsed">
          <div class="setting-item">
            <label>
              侧边栏默认展开
              <label class="switch">
                <input type="checkbox" id="sidebarAutoExpand">
                <span class="slider"></span>
              </label>
            </label>
            <div class="item-desc">加载文档时自动展开侧边栏标题列表</div>
          </div>
          <div class="setting-item">
            <label>
              搜索高亮
              <label class="switch">
                <input type="checkbox" id="searchHighlight" checked>
                <span class="slider"></span>
              </label>
            </label>
            <div class="item-desc">搜索结果在文档中高亮显示</div>
          </div>
          <div class="setting-item">
            <label>
              搜索大小写敏感
              <label class="switch">
                <input type="checkbox" id="caseSensitiveSearch">
                <span class="slider"></span>
              </label>
            </label>
            <div class="item-desc">搜索时区分字母大小写</div>
          </div>
          <div class="setting-item">
            <label>
              平滑滚动
              <label class="switch">
                <input type="checkbox" id="smoothScroll" checked>
                <span class="slider"></span>
              </label>
            </label>
            <div class="item-desc">点击导航时平滑滚动到目标位置</div>
          </div>
        </div>
      </div>

      <!-- 4. 高级设置分组 -->
      <div class="settings-group">
        <div class="settings-group-header" onclick="toggleGroup(this)">
          <span class="settings-group-title">高级设置</span>
          <span class="group-toggle"><i class="fas fa-chevron-right"></i></span>
        </div>
        <div class="settings-group-content collapsed">
          <div class="setting-item">
            <label>
              粒子效果
              <label class="switch">
                <input type="checkbox" id="enableParticles" checked>
                <span class="slider"></span>
              </label>
            </label>
            <div class="item-desc">启用/禁用页面背景粒子动画效果</div>
          </div>
          <div class="setting-item">
            <label>
              粒子数量
              <span id="particleCountValue">50</span>
            </label>
            <input type="range" id="particleCount" min="20" max="100" step="5" value="50">
            <div class="item-desc">调整背景粒子动画的粒子数量</div>
          </div>
          <div class="setting-item">
            <label>
              缓存设置
              <label class="switch">
                <input type="checkbox" id="enableCache" checked>
                <span class="slider"></span>
              </label>
            </label>
            <div class="item-desc">启用本地缓存（保存设置和历史记录）</div>
          </div>
          <div class="setting-item">
            <label>
              清除缓存
              <button id="clearCacheBtn" class="reset-btn" style="padding:4px 8px;font-size:12px;">立即清除</button>
            </label>
            <div class="item-desc">清除所有本地缓存数据（包括设置和历史）</div>
          </div>
          <div class="setting-item">
            <label>
              调试模式
              <label class="switch">
                <input type="checkbox" id="debugMode">
                <span class="slider"></span>
              </label>
            </label>
            <div class="item-desc">启用调试模式（显示控制台日志，仅开发者使用）</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 底部操作栏 -->
    <div class="settings-footer">
      <button id="importSettingsBtn" class="import-btn">
        <i class="fas fa-upload"></i>导入设置
      </button>
      <button id="exportSettingsBtn" class="export-btn">
        <i class="fas fa-download"></i>导出设置
      </button>
      <button id="resetSettingsBtn" class="reset-btn">
        <i class="fas fa-redo"></i>重置默认
      </button>
      <button id="applySettingsBtn" class="apply-btn">
        <i class="fas fa-check"></i>应用设置
      </button>
    </div>
  </div>

  <!-- 导入设置弹窗 -->
  <div id="importModal" class="settings-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h4>导入设置</h4>
        <button class="modal-close" onclick="closeModal('importModal')">×</button>
      </div>
      <div class="modal-body">
        <p style="margin:0 0 8px 0;font-size:14px;">粘贴设置JSON代码（从其他设备导出）：</p>
        <textarea id="importText" placeholder='{"fontSize":"16","lineHeight":"1.5",...}'></textarea>
      </div>
      <div class="modal-footer">
        <button class="modal-cancel" onclick="closeModal('importModal')">取消</button>
        <button class="modal-confirm" onclick="importSettings()">确认导入</button>
      </div>
    </div>
  </div>

  <!-- 导出设置弹窗 -->
  <div id="exportModal" class="settings-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h4>导出设置</h4>
        <button class="modal-close" onclick="closeModal('exportModal')">×</button>
      </div>
      <div class="modal-body">
        <p style="margin:0 0 8px 0;font-size:14px;">复制以下JSON代码（可导入到其他设备）：</p>
        <textarea id="exportText" readonly></textarea>
      </div>
      <div class="modal-footer">
        <button class="modal-cancel" onclick="closeModal('exportModal')">关闭</button>
        <button class="modal-confirm" onclick="copyExportText()">复制代码</button>
      </div>
    </div>
  </div>

  <div class="content-wrapper">
    <div class="sidebar-container">
      <div class="sidebar">
        <div class="search-container">
          <div class="search-box">
            <input type="text" id="searchInput" placeholder="搜索文档..." style="display:none">
            <button id="searchBtn" class="search-button">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M15.5 14H14.71L14.43 13.73C15.41 12.59 16 11.11 16 9.5C16 5.91 13.09 3 9.5 3C5.91 3 3 5.91 3 9.5C3 13.09 5.91 16 9.5 16C11.11 16 12.59 15.41 13.73 14.43L14 14.71V15.5L19 20.49L20.49 19L15.5 14ZM9.5 14C7.01 14 5 11.99 5 9.5C5 7.01 7.01 5 9.5 5C11.99 5 14 7.01 14 9.5C14 11.99 11.99 14 9.5 14Z"
                  fill="currentColor" />
              </svg>
            </button>
          </div>
          <div class="search-results-container">
            <div class="search-results" id="searchResults"></div>
          </div>
        </div>
        <div class="document-list">
          <!-- 标题将由renderTitles函数动态生成 -->
        </div>
      </div>
    </div>
    <div class="content-container">
      <div class="document-content" id="documentContent"></div>
      <div class="right-sidebar">
        <div class="right-sidebar-inner">
          <div class="ai-chat-container">
            <!-- 问答消息区域 -->
            <div class="ai-chat-messages">
              <!-- AI欢迎消息 -->
              <div class="message ai-message">
                <div class="message-content">
                  你好！我是智能助手，有什么可以帮助你的吗？
                </div>
                <div class="message-time">刚刚</div>
              </div>

              <!-- 用户消息示例 -->
              <div class="message user-message">
                <div class="message-content">
                  如何使用这个系统？
                </div>
                <div class="message-time">刚刚</div>
              </div>

              <!-- AI回复示例 -->
              <div class="message ai-message">
                <div class="message-content">
                  你可以通过左侧导航浏览文档，使用顶部搜索框查找内容，或者在设置中调整显示偏好。有具体问题可以随时问我哦！
                </div>
                <div class="message-time">刚刚</div>
              </div>
            </div>

            <!-- 底部输入区域 -->
            <div class="ai-chat-input">
              <div class="chat-input-wrapper">
                <textarea placeholder="输入你的问题..."></textarea>
                <button class="send-btn">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
              <div class="chat-actions">
                <button class="chat-action-btn knowledge-btn">
                  <i class="fas fa-database"></i> 关联知识库
                </button>
                <button class="chat-action-btn file-btn">
                  <i class="fas fa-file-import"></i> 加载文件
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- 将收缩按钮移出right-sidebar -->
    <button class="sidebar-collapse-btn" id="collapseRightSidebar">
      <i class="fas fa-chevron-left"></i>
    </button>
  </div>
  </div>

  <!-- 文本选中聊天框 -->
  <div id="textChatPanel" class="text-chat-panel">
    <div class="chat-header">
      <h3>文本问答</h3>
      <button id="closeChatBtn" class="close-btn">×</button>
    </div>
    <div id="selectedTextArea" class="selected-text-area"></div>
    <div id="chatResponseArea" class="chat-response-area"></div>
    <div class="chat-input-area">
      <select id="chatInput">
        <option value="" disabled selected>选择问题...</option>
        <option value="如何保存当前文档？">如何保存当前文档？</option>
        <option value="如何导出设置？">如何导出设置？</option>
        <option value="如何使用专注模式？">如何使用专注模式？</option>
        <option value="如何导入文档？">如何导入文档？</option>
      </select>
      <button id="submitChatBtn">提交</button>
    </div>
  </div>

  <!-- 悬浮球组件 -->
  <div id="app">
    <!-- 悬浮球 -->
    <div id="floatingBall" class="floating-ball" @mousedown="startDrag" @click="toggleTools" :style="ballPosition"
      @mousedown.stop>
      <!-- 悬浮球图标 -->
      <i class="fas fa-tools"></i>
    </div>

    <!-- 悬浮工具面板 -->
    <div id="floatingTools" class="floating-tools" :style="toolsPosition">
      <div class="function-buttons">
        <!-- 工具按钮 -->
        <button id="downloadBtn"><i class="fas fa-download"></i>下载</button>
        <button id="editBtn"><i class="fas fa-edit"></i>修改</button>
        <button id="saveBtn" style="display: none;"><i class="fas fa-save"></i>保存</button>
        <button id="loadFileBtn"><i class="fas fa-folder-open"></i>加载文件</button>
        <button id="toggleSidebarBtn" class="toggle-btn"><i class="fas fa-bars"></i>隐藏侧边栏</button>
        <button id="settingsBtn" class="settings-btn"><i class="fas fa-cog"></i>设置</button>
        <button id="focusModeBtn" class="focus-btn"><i class="fas fa-crosshairs"></i>专注模式</button>
      </div>
    </div>
  </div>

  <script src="base.js"></script>
  <script src="particles.js"></script>
  <script src="./file-uploader.js"></script>
  <script>
    // 悬浮球功能实现
    document.addEventListener('DOMContentLoaded', function () {
      new Vue({
        el: '#app',
        data() {
          return {
            isDragging: false,
            ballPosition: { right: '30px', bottom: '30px' },
            toolsPosition: { right: '90px', bottom: '30px' },
            toolsVisible: false,
            offset: { x: 0, y: 0 },
            handleDragFn: null,
            stopDragFn: null,
            rightSidebarCollapsed: false,
            messages: [
              {
                id: 1,
                content: '你好！我是智能助手，有什么可以帮助你的吗？',
                sender: 'ai',
                time: '刚刚'
              }
            ],
            inputMessage: '',
            isLoading: false,
            selectedText: '',
            chatResponse: '请输入问题'
          };
        },
        methods: {
          startDrag(e) {
            e.stopPropagation();
            e.preventDefault();
            this.isDragging = true;
            const ball = document.getElementById('floatingBall');
            const rect = ball.getBoundingClientRect();
            this.offset.x = e.clientX - rect.left;
            this.offset.y = e.clientY - rect.top;

            this.handleDragFn = (e) => this.handleDrag(e);
            this.stopDragFn = () => this.stopDrag();

            document.addEventListener('mousemove', this.handleDragFn);
            document.addEventListener('mouseup', this.stopDragFn);
          },

          handleDrag(e) {
            if (!this.isDragging) return;
            e.preventDefault();

            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const ballWidth = 50;
            const ballHeight = 50;
            const toolsWidth = 300;
            const gap = 10;

            let newX = e.clientX - this.offset.x;
            let newY = e.clientY - this.offset.y;
            newX = Math.max(0, Math.min(newX, windowWidth - ballWidth));
            newY = Math.max(0, Math.min(newY, windowHeight - ballHeight));

            this.ballPosition = {
              left: `${newX}px`,
              top: `${newY}px`,
              right: 'auto',
              bottom: 'auto'
            };

            let toolsX;
            const spaceRight = windowWidth - (newX + ballWidth);
            const spaceLeft = newX;

            if (spaceRight >= toolsWidth + gap) {
              toolsX = newX + ballWidth + gap;
            } else if (spaceLeft >= toolsWidth + gap) {
              toolsX = newX - toolsWidth - gap;
            } else {
              if (spaceRight > spaceLeft) {
                toolsX = windowWidth - toolsWidth - gap;
              } else {
                toolsX = gap;
              }
            }

            toolsX = Math.max(gap, Math.min(toolsX, windowWidth - toolsWidth - gap));

            this.toolsPosition = {
              left: `${toolsX}px`,
              top: `${newY + (ballHeight - 60) / 2}px`,
              right: 'auto',
              bottom: 'auto'
            };
          },

          stopDrag() {
            this.isDragging = false;
            document.removeEventListener('mousemove', this.handleDragFn);
            document.removeEventListener('mouseup', this.stopDragFn);
          },

          toggleTools(e) {
            if (!this.isDragging) {
              e.stopPropagation();
              this.toolsVisible = !this.toolsVisible;
              const tools = document.getElementById('floatingTools');
              tools.classList.toggle('active', this.toolsVisible);
            }
          },
          toggleRightSidebar() {
            const rightSidebar = document.querySelector('.right-sidebar');
            const collapseBtn = document.querySelector('.sidebar-collapse-btn');
            const documentContent = document.getElementById('documentContent');

            if (rightSidebar && collapseBtn && documentContent) {
              // 切换收缩状态类
              rightSidebar.classList.toggle('collapsed');

              // 保存状态到本地存储
              localStorage.setItem('rightSidebarCollapsed', rightSidebar.classList.contains('collapsed'));

              // 切换图标和位置
              const icon = collapseBtn.querySelector('i');
              if (icon) {
                if (rightSidebar.classList.contains('collapsed')) {
                  icon.classList.remove('fa-chevron-left');
                  icon.classList.add('fa-chevron-right');
                  documentContent.style.marginRight = '20px';
                  // 确保边栏宽度为0
                  rightSidebar.style.width = '0';
                } else {
                  icon.classList.remove('fa-chevron-right');
                  icon.classList.add('fa-chevron-left');
                  documentContent.style.marginRight = '350px';
                  // 恢复边栏宽度
                  rightSidebar.style.width = '330px';
                }
              }
            }
          },
          initToolButtons() {
            // 为每个按钮添加存在性检查
            const settingsBtn = document.getElementById('settingsBtn');
            if (settingsBtn) {
              settingsBtn.addEventListener('click', () => {
                document.getElementById('settingsPanel').style.display = 'block';
                this.toolsVisible = false;
              });
            }

            const downloadBtn = document.getElementById('downloadBtn');
            if (downloadBtn) {
              downloadBtn.addEventListener('click', () => {
                if (currentFile) {
                  saveFile();
                } else {
                  alert('没有文件可下载，请先加载文件');
                }
                this.toolsVisible = false;
              });
            }

            const loadFileBtn = document.getElementById('loadFileBtn');
            if (loadFileBtn) {
              loadFileBtn.addEventListener('click', () => {
                readAndDisplayFile();
                this.toolsVisible = false;
              });
            }

            const editBtn = document.getElementById('editBtn');
            if (editBtn) {
              editBtn.addEventListener('click', () => {
                toggleEditMode();
                this.toolsVisible = false;
              });
            }

            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
              saveBtn.addEventListener('click', () => {
                saveFile();
                this.toolsVisible = false;
              });
            }

            const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
            if (toggleSidebarBtn) {
              toggleSidebarBtn.addEventListener('click', () => {
                const sidebarContainer = document.querySelector('.sidebar-container');
                if (sidebarContainer) {
                  sidebarContainer.classList.toggle('hidden');
                  toggleSidebarBtn.innerHTML = sidebarContainer.classList.contains('hidden') ?
                    '<i class="fas fa-bars"></i>显示侧边栏' :
                    '<i class="fas fa-bars"></i>隐藏侧边栏';
                  this.toolsVisible = false;
                }
              });
            }

            const focusModeBtn = document.getElementById('focusModeBtn');
            if (focusModeBtn) {
              focusModeBtn.addEventListener('click', () => {
                const focusContent = document.getElementById('focusContent');
                const focusModeContainer = document.getElementById('focusModeContainer');
                const documentContent = document.getElementById('documentContent');

                if (focusContent && focusModeContainer && documentContent) {
                  focusContent.innerHTML = documentContent.innerHTML;

                  const savedSettings = localStorage.getItem('appSettings');
                  if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    focusContent.style.fontSize = `${settings.fontSize}px`;
                    focusContent.style.lineHeight = settings.lineHeight;
                  }

                  focusModeContainer.classList.add('active');
                  this.toolsVisible = false;
                }
              });
            }

            const closeSettingsBtn = document.getElementById('closeSettingsBtn');
            if (closeSettingsBtn) {
              closeSettingsBtn.addEventListener('click', () => {
                document.getElementById('settingsPanel').style.display = 'none';
              });
            }
          },
          async sendMessage() {
            if (!this.inputMessage.trim() || this.isLoading) return;

            // 添加用户消息到列表
            this.messages.push({
              id: Date.now(),
              content: this.inputMessage,
              sender: 'user',
              time: this.formatTime(new Date())
            });

            this.isLoading = true;
            const message = this.inputMessage;
            this.inputMessage = '';

            try {
              const response = await axios.post('/api/ai/chat', {
                message: message,
                context: this.messages.slice(-5).map(m => ({
                  role: m.sender === 'ai' ? 'assistant' : 'user',
                  content: m.content
                }))
              });

              // 添加AI回复到列表
              this.messages.push({
                id: Date.now() + 1,
                content: response.data.content,
                sender: 'ai',
                time: this.formatTime(new Date())
              });

              // 滚动到底部
              this.scrollToBottom();
            } catch (error) {
              console.error('AI接口调用失败:', error);
              this.messages.push({
                id: Date.now() + 2,
                content: '抱歉，暂时无法获取回复，请稍后再试',
                sender: 'ai',
                time: this.formatTime(new Date())
              });
            } finally {
              this.isLoading = false;
            }
          },

          // 针对选中的文本提问
          async sendSelectedTextQuery() {
            if (!this.selectedText || !this.inputMessage.trim() || this.isLoading) return;

            this.isLoading = true;
            const question = this.inputMessage;
            const text = this.selectedText;

            try {
              const response = await axios.post('/api/ai/text-query', {
                text: text,
                question: question
              });

              this.chatResponse = response.data.answer;
              this.inputMessage = '';
            } catch (error) {
              console.error('文本问答接口调用失败:', error);
              this.chatResponse = '抱歉，处理失败，请重试';
            } finally {
              this.isLoading = false;
            }
          },

          // 格式化时间显示
          formatTime(date) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
          },

          // 滚动到消息底部
          scrollToBottom() {
            this.$nextTick(() => {
              const chatContainer = document.querySelector('.ai-chat-messages');
              if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
              }
            });
          },

          // 选择文本处理
          handleTextSelection() {
            const selection = window.getSelection();
            if (selection.toString().trim()) {
              this.selectedText = selection.toString();
              document.getElementById('selectedTextArea').textContent = this.selectedText;
              document.getElementById('textChatPanel').classList.add('active');
            }
          }
        },
        mounted() {
          this.initToolButtons();
          this.ballPosition = {
            right: '30px',
            bottom: '30px',
            left: 'auto',
            top: 'auto'
          };

          this.toolsPosition = {
            right: '90px',
            bottom: '30px',
            left: 'auto',
            top: 'auto'
          };
          document.getElementById('collapseRightSidebar')
            .addEventListener('click', this.toggleRightSidebar);








          document.addEventListener('click', (e) => {
            const ball = document.getElementById('floatingBall');
            const tools = document.getElementById('floatingTools');
            if (!ball.contains(e.target) && !tools.contains(e.target)) {
              this.toolsVisible = false;
              tools.classList.remove('active');
            }
          });
          const isCollapsed = localStorage.getItem('rightSidebarCollapsed') === 'true';
          const rightSidebar = document.querySelector('.right-sidebar');
          if (rightSidebar && isCollapsed) {
            rightSidebar.classList.add('collapsed');
            const icon = document.querySelector('.sidebar-collapse-btn i');
            if (icon) {
              icon.classList.remove('fa-chevron-left');
              icon.classList.add('fa-chevron-right');
            }
            document.getElementById('documentContent').style.marginRight = '20px';
            document.addEventListener('mouseup', this.handleTextSelection);

            // 绑定发送按钮点击事件
            document.querySelector('.send-btn').addEventListener('click', () => {
              this.sendMessage();
            });

            // 绑定文本问答提交按钮
            document.getElementById('submitChatBtn').addEventListener('click', () => {
              this.sendSelectedTextQuery();
            });

            // 绑定回车键发送消息
            document.querySelector('.ai-chat-input textarea').addEventListener('keydown', (e) => {
              if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
              }
            });
          }
        },
        beforeDestroy() {
          // 清理事件监听
          document.getElementById('collapseRightSidebar')
            .removeEventListener('click', this.toggleRightSidebar);
        },

      });
    });
  </script>
</body>

</html>