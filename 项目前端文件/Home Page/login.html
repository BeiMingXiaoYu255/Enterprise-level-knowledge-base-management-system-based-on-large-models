<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="./black.ico" type="image/x-icon">
    <title>知识管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <!-- 引入 Axios 库 -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
    <!-- 科技感背景 -->
    <div class="tech-background" id="techBackground"></div>

    <!-- 主容器 -->
    <div class="main-container">
        <!-- 左侧品牌展示区 -->
        <div class="brand-section">
            <div class="brand-content">
                <div class="company-logo">
                    <div class="logo-icon">HS</div>
                    <div class="company-name">恒生电子</div>
                </div>

                <div class="slogan">让金融变简单</div>

                <ul class="feature-list">
                    <li>
                        <i class="fas fa-brain"></i>
                        <div>企业级<span class="brand-">智能知识管理系统</span>，整合多样化知识内容，助力业务创新</div>
                    </li>
                    <li>
                        <i class="fas fa-bolt"></i>
                        <div>自适应知识优化能力，支持代码撰写、客户服务、问题排查等多种业务场景</div>
                    </li>
                    <li>
                        <i class="fas fa-chart-line"></i>
                        <div>提升企业知识资产利用率，驱动运营效率提升与业务创新</div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- 右侧登录区 -->
        <div class="login-section">
            <div class="login-head">
                <h2 class="login-title">知识管理系统</h2>
                <p class="login-subtitle">请登录您的账户以获取企业知识资产</p>
            </div>

            <!--登录界面的填写部分-->
            <div class="loginn">
                <!--登录注册界面切换按钮-->
                <div class="tab-buttons">
                    <button @click="switchTab('login')" :class="{active: currentTab === 'login'}">
                        <i class="fas fa-sign-in-alt"></i> <span>登录</span>
                    </button>
                    <button @click="switchTab('register');getverificationCode"
                        :class="{active: currentTab === 'register'}">
                        <i class="fas fa-user-plus"></i> <span>注册</span>
                    </button>
                </div>

                <!--登录界面-->
                <div class="login-form1" v-if="currentTab === 'login'">

                    <!-- <h4>账户登录</h4> -->

                    <div class="relative">
                        <i class="fas fa-user"></i>
                        <input type="text" class="form-control" v-model="loginform.username" placeholder="请输入用户名">
                    </div>
                    <div class="relative">
                        <i class="fas fa-lock"></i>
                        <input type="password" class="form-control" v-model="loginform.password" placeholder="请输入密码">
                    </div>

                    <!-- 协议勾选框 -->
                    <div class="agreement">
                        <input type="checkbox" id="login-agreement" v-model="agreementAccepted">
                        <label for="login-agreement">
                            我已阅读并同意 <a href="#">《用户协议》</a> 和 <a href="#">《隐私政策》</a>
                        </label>
                    </div>

                    <div class="form-actions">
                        <button class="btn-primary" @click="denglu">登录</button>
                        <button class="btn-secondary" @click="reset">重置</button>
                    </div>

                    <!-- 链接样式，点击忘记密码后跳转到密码重置页面 -->
                    <button @click="switchTab('refresh')" class="link-text">忘记密码?</button>

                </div>

                <!--注册界面-->
                <div class="login-form2" v-if="currentTab === 'register'">
                    <!-- <h4>账户注册</h4> -->

                    <div class="relative">
                        <i class="fas fa-user"></i>
                        <input type="text" class="form-control" v-model="registerform.username" placeholder="请输入用户名">
                    </div>

                    <div class="relative">
                        <i class="fas fa-lock"></i>
                        <input type="password" class="form-control" v-model="registerform.password" placeholder="请输入密码">
                    </div>

                    <div class="relative">
                        <i class="fas fa-lock"></i>
                        <input type="password" class="form-control" v-model="registerform.confirmPassword"
                            placeholder="请确认密码">
                    </div>

                    <div class="relative">
                        <i class="fas fa-envelope"></i>
                        <input type="email" class="form-control" v-model="registerform.email" placeholder="请输入邮箱">
                    </div>

                    <!-- 图形验证码 -->
                    <div class="verification">
                        <div class="relative">
                            <i class="fas fa-shield-alt"></i>
                            <input type="text" class="form-control" v-model="registerform.captchaCode"
                                placeholder="请输入验证码">
                        </div>
                        <div class="verification-container">
                            <img :src="captcha" alt="验证码" @click="getverificationCode" style="cursor: pointer;"
                                title="点击刷新验证码" />
                        </div>
                    </div>

                    <div class="agreement">
                        <input type="checkbox" id="register-agreement" v-model="agreementAccepted">
                        <label for="register-agreement">
                            我已阅读并同意 <a href="#">《用户协议》</a> 和 <a href="#">《隐私政策》</a>
                        </label>
                    </div>

                    <div class="form-actions">
                        <button class="btn-primary" @click="zhuce">注册</button>
                        <button class="btn-secondary" @click="reset">重置</button>
                    </div>
                </div>

                <!--找回密码界面-->
                <div class="login-form3" v-if="currentTab ==='refresh'">
                    <h4>重置密码</h4>

                    <div class="relative">
                        <i class="fas fa-user"></i>
                        <input type="text" class="form-control" v-model="refreshform.username" placeholder="请输入用户名">
                    </div>

                    <div class="relative">
                        <i class="fas fa-envelope"></i>
                        <input type="email" class="form-control" v-model="refreshform.email" placeholder="请输入邮箱">
                    </div>

                    <div class="relative">
                        <i class="fas fa-lock"></i>
                        <input type="password" class="form-control" v-model="refreshform.password" placeholder="请输入新密码">
                    </div>

                    <div class="relative">
                        <i class="fas fa-lock"></i>
                        <input type="password" class="form-control" v-model="refreshform.confirmPassword"
                            placeholder="请确认新密码">
                    </div>

                    <!-- 图形验证码 -->
                    <div class="verification">
                        <div class="relative">
                            <i class="fas fa-shield-alt"></i>
                            <input type="text" class="form-control" v-model="refreshform.captchaCode"
                                placeholder="请输入验证码">
                        </div>
                        <div class="verification-container">
                            <img :src="captcha" alt="验证码" @click="getverificationCode" style="cursor: pointer;"
                                title="点击刷新验证码" />
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="btn-primary" @click="updatepassword">更新</button>
                        <button class="btn-secondary" @click="reset">重置</button>
                    </div>
                </div>

                <!-- 弹窗 -->
                <div :class="{'modal': true, 'active': showSuccessModal}" @click.self="closeModal">
                    <div class="modal-content">
                        <p>{{ modalMessage }}</p>
                        <button @click="closeModal">确认</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>© 2025 恒生电子企业级知识管理系统</p>
        <p>科技赋能金融，智慧驱动未来</p>
        <div class="footer-links">
            <a href="#">隐私政策</a>
            <a href="#">使用条款</a>
            <a href="#">联系我们</a>
            <a href="#">帮助中心</a>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>


    <script>
        // 创建科技感背景线条和点
        function createTechElements() {
            const container = document.getElementById('techBackground');
            const lineCount = 15;
            const dotCount = 30;

            // 创建线条
            for (let i = 0; i < lineCount; i++) {
                const line = document.createElement('div');
                line.classList.add('tech-line');

                // 随机位置和动画延迟
                const top = Math.random() * 100;
                const delay = Math.random() * 15;
                const duration = 10 + Math.random() * 20;

                line.style.top = `${top}%`;
                line.style.width = `${20 + Math.random() * 60}%`;
                line.style.animationDelay = `-${delay}s`;
                line.style.animationDuration = `${duration}s`;
                line.style.opacity = `${0.1 + Math.random() * 0.3}`;

                container.appendChild(line);
            }

            // 创建点
            for (let i = 0; i < dotCount; i++) {
                const dot = document.createElement('div');
                dot.classList.add('tech-dot');

                // 随机位置和动画延迟
                const top = Math.random() * 100;
                const left = Math.random() * 100;
                const delay = Math.random() * 8;
                const duration = 6 + Math.random() * 6;

                dot.style.top = `${top}%`;
                dot.style.left = `${left}%`;
                dot.style.animationDelay = `-${delay}s`;
                dot.style.animationDuration = `${duration}s`;

                container.appendChild(dot);
            }
        }

        // 在页面加载完成后创建背景元素
        document.addEventListener('DOMContentLoaded', createTechElements);

        // 确保Axios已加载
        if (typeof axios === 'undefined') {
            console.error('Axios未加载！请检查网络连接或引入路径。');
            alert('系统加载失败，请刷新页面重试');
        } else {
            console.log('Axios已成功加载');
        }

        const login = new Vue({
            el: '.loginn',
            data: {
                currentTab: 'login',
                showSuccessModal: false,
                modalMessage: '操作成功！',
                loginLoading: false,
                registerLoading: false,
                resetLoading: false,
                agreementAccepted: false,

                loginform: {
                    username: '',
                    password: '',
                    captchaCode: ''
                },
                registerform: {
                    username: '',
                    password: '',
                    confirmPassword: '',
                    email: '',
                    captchaCode: ''
                },
                refreshform: {
                    username: '',
                    email: '',
                    password: '',
                    confirmPassword: '',
                    captchaCode: '',
                },
                captcha: '',
                captchaCode: '' // 存储验证码的文本值
            },

            methods: {
                switchTab(tab) {
                    this.currentTab = tab;
                },

                denglu() {
                    // 验证用户是否全部填写
                    if (!this.loginform.username) {
                        this.showModal('请输入用户名');
                        return;
                    }
                    if (!this.loginform.password) {
                        this.showModal('请输入密码');
                        return;
                    }
                    if (!this.agreementAccepted) {
                        this.showModal('请阅读并同意用户协议和隐私政策');
                        return;
                    }
                    //添加登录api调用
                    console.log('登录数据', this.loginform);
                    const loginData = {
                        username: this.loginform.username,
                        password: this.loginform.password,
                        captchaCode: this.loginform.captchaCode
                    };

                    this.loginLoading = true;
                    this.loginError = '';

                    // 使用 Axios 替换 fetch，并设置验证码请求头
                    axios.post('http://localhost:8080/user/login', loginData, {
                        headers: {
                            'captcha': this.captchaCode || ''
                        },
                        withCredentials: true
                    })
                        .then(response => {
                            if (response.data.code === 1 && response.data.msg === 'success') {
                                console.log('登录成功', response.data);

                                // 从后端响应中获取token
                                const token = response.data.token;
                                if (token) {
                                    // 设置会话Cookie（关闭浏览器后失效）
                                    this.setSessionCookie(this.loginform.username, token);
                                    console.log(`已设置Cookie: ${this.loginform.username}=${token}`);
                                } else {
                                    console.warn('后端未返回token数据');
                                }

                                this.showModal('登录成功');
                                // 登录成功后跳转到 main 页面
                                setTimeout(() => {
                                    window.location.href = '/FinalVersionWebSystem/项目14（汇总）/main.html?_ijt=t5lvbq4sda2tkka5b1m6a2givm&_ij_reload=RELOAD_ON_SAVE';
                                }, 1500);
                            } else {
                                this.loginError = response.data.msg || '登录失败，请检查账号密码';
                                this.showModal(this.loginError);
                            }
                        })
                        .catch(error => {
                            console.error('登录错误', error);
                            if (error.response) {
                                this.loginError = `登录失败 (${error.response.status})`;
                            } else if (error.request) {
                                this.loginError = '服务器无响应，请检查API地址';
                            } else {
                                this.loginError = '登录失败，请稍后再试';
                            }
                            this.showModal(this.loginError);
                        })
                        .finally(() => {
                            this.loginLoading = false;
                        });
                },

                reset() {
                    if (this.currentTab === 'login') {
                        this.loginform = {
                            username: '',
                            password: '',
                            captchaCode: ''
                        };
                    }
                    else if (this.currentTab === 'register') {
                        this.registerform = {
                            username: '',
                            password: '',
                            confirmPassword: '',
                            email: '',
                            captchaCode: ''
                        };
                    }
                    else if (this.currentTab === 'refresh') {
                        this.refreshform = {
                            username: '',
                            email: '',
                            password: '',
                            confirmPassword: '',
                            captchaCode: ''
                        };

                    }
                },

                zhuce() {
                    if (!this.registerform.username) {
                        this.showModal('请输入用户名');
                        return;
                    }
                    if (!this.registerform.password) {
                        this.showModal('请输入密码');
                        return;
                    }
                    if (!this.registerform.confirmPassword) {
                        this.showModal('请确认密码');
                        return;
                    }
                    if (this.registerform.password !== this.registerform.confirmPassword) {
                        this.showModal('两次输入的密码不一致');
                        return;
                    }
                    if (!this.registerform.email) {
                        this.showModal('请输入邮箱');
                        return;
                    }
                    if (!this.registerform.captchaCode) {
                        this.showModal('请输入验证码');
                        return;
                    }

                    console.log('注册数据', this.registerform);
                    //添加注册api调用

                    const registerData = {
                        username: this.registerform.username,
                        password: this.registerform.password,
                        confirmPassword: this.registerform.confirmPassword,
                        email: this.registerform.email,
                        captchaCode: this.registerform.captchaCode
                    };
                    this.registerLoading = true;
                    this.registerError = '';

                    // 使用 Axios 替换 fetch，并设置验证码请求头
                    axios.post('http://localhost:8080/user/register', registerData, {
                        headers: {
                            'captcha': this.captchaCode || ''
                        },
                        withCredentials: true
                    })
                        .then(response => {
                            if (response.data.code === 1 && response.data.msg === 'success') {
                                console.log('注册成功', response.data);
                                this.showModal('注册成功');
                                this.registerSuccess = true;
                                this.registerform = {
                                    username: '',
                                    password: '',
                                    confirmPassword: '',
                                    email: '',
                                    captchaCode: '',
                                };
                                setTimeout(() => {
                                    this.switchTab('login');
                                }, 2000);
                            } else {
                                this.registerError = response.data.msg || '注册失败,未知错误';
                                this.showModal(this.registerError);
                                this.getverificationCode(); // 刷新验证码
                            }
                        })
                        .catch(error => {
                            console.error('注册错误', error);
                            if (error.response) {
                                this.registerError = `注册失败 (${error.response.status})`;
                            } else if (error.request) {
                                this.registerError = '服务器无响应，请检查API地址';
                            } else {
                                this.registerError = '注册失败，请稍后再试';
                            }
                            this.showModal(this.registerError);
                            this.getverificationCode(); // 刷新验证码
                        })
                        .finally(() => {
                            this.registerLoading = false;
                        });
                },

                updatepassword() {
                    console.log('重置密码数据', this.refreshform);
                    if (!this.refreshform.username) {
                        this.showModal('请输入用户名');
                        return;
                    }
                    if (!this.refreshform.email) {
                        this.showModal('请输入邮箱');
                        return;
                    }
                    if (!this.refreshform.password) {
                        this.showModal('请输入新密码');
                        return;
                    }
                    if (!this.refreshform.confirmPassword) {
                        this.showModal('请确认新密码');
                        return;
                    }
                    if (this.refreshform.password !== this.refreshform.confirmPassword) {
                        this.showModal('两次输入的密码不一致');
                        return;
                    }
                    if (!this.refreshform.captchaCode) {
                        this.showModal('请输入验证码');
                        return;
                    }

                    // 添加找回密码API调用
                    console.log('重置密码数据', this.refreshform);
                    const resetData = {
                        username: this.refreshform.username,
                        email: this.refreshform.email,
                        newPassword: this.refreshform.password,
                        captchaCode: this.refreshform.captchaCode
                    };

                    this.resetLoading = true;
                    this.resetError = '';

                    // 使用 Axios 替换 fetch，并设置验证码请求头
                    axios.post('http://localhost:8080/user/recover-password', resetData, {
                        headers: {
                            'captcha': this.captchaCode || ''
                        },
                        withCredentials: true
                    })
                        .then(response => {
                            if (response.data.code === 1 && response.data.msg === 'success') {
                                console.log('密码重置成功', response.data);
                                this.showModal('密码重置成功，将自动返回登录界面');

                                setTimeout(() => {
                                    this.refreshform = {
                                        username: '',
                                        email: '',
                                        password: '',
                                        confirmPassword: '',
                                        captchaCode: ''
                                    };
                                    this.switchTab('login');
                                }, 2000);
                            } else {
                                this.resetError = response.data.msg || '用户信息不存在，请检查用户名和邮箱';
                                this.showModal(this.resetError);
                                this.getverificationCode(); // 刷新验证码
                            }
                        })
                        .catch(error => {
                            console.error('密码重置错误', error);
                            if (error.response) {
                                this.resetError = `密码重置失败 (${error.response.status})`;
                            } else if (error.request) {
                                this.resetError = '服务器无响应，请检查API地址';
                            } else {
                                this.resetError = '密码重置失败，请稍后再试';
                            }
                            this.showModal(this.resetError);
                            this.getverificationCode(); // 刷新验证码
                        })
                        .finally(() => {
                            this.resetLoading = false;
                        });
                },

                // 显示模态框
                showModal(message) {
                    this.modalMessage = message;
                    this.showSuccessModal = true;
                },

                closeModal() {
                    this.showSuccessModal = false;
                    if (this.modalMessage.includes('登录') || this.modalMessage.includes('修改')) {
                        setTimeout(() => {
                            this.switchTab('login');
                            this.refreshform = {
                                username: '',
                                email: '',
                                password: '',
                                confirmPassword: '',
                                captchaCode: '',
                            };
                        }, 300);
                    }
                },

                //获取验证码
                getverificationCode() {
                    if (this.captcha) {
                        URL.revokeObjectURL(this.captcha);
                    }
                    // 实际获取验证码的逻辑
                    // 使用 responseType: 'blob' 确保正确处理二进制响应
                    axios.get('https://frp-hub.com:39340/user/captcha', { responseType: 'blob' })
                        .then(response => {
                            const blob = new Blob([response.data], { type: 'image/png' });
                            this.captcha = URL.createObjectURL(blob);  // 更新验证码图片
                            // 从响应头获取验证码文本
                            this.captchaCode = response.headers.captcha || '';
                            console.log('获取验证码成功，验证码值:', this.captchaCode);
                        })
                        .catch(error => {
                            console.error('获取验证码时出错:', error);
                            this.showModal('获取验证码失败，请检查服务器连接');
                            if (error.response) {
                                console.error('服务器响应错误:', error.response.status);
                            }
                        });
                },

                // 设置会话Cookie（关闭浏览器后失效）
                setSessionCookie(name, value, path = '/') {
                    // 不设置expires参数，Cookie将在会话结束（浏览器关闭）时过期
                    const encodedValue = encodeURIComponent(value);
                    const pathStr = path ? `; path=${path}` : '';
                    document.cookie = `${name}=${encodedValue}${pathStr}`;
                },

                // 原有设置带过期时间Cookie的方法保留
                setCookie(name, value, days = 1, path = '/', domain = '') {
                    let expires = '';
                    if (days) {
                        const date = new Date();
                        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                        expires = `; expires=${date.toUTCString()}`;
                    }
                    const domainStr = domain ? `; domain=${domain}` : '';
                    const pathStr = `; path=${path}`;
                    document.cookie = `${name}=${encodeURIComponent(value)}${expires}${domainStr}${pathStr}`;
                },
            },

            // 添加创建钩子，用于初始化
            created() {
                console.log('Vue实例已创建');
                // 页面加载时获取验证码
                this.getverificationCode();
            },

            // 添加mounted钩子，确保DOM加载完成后再获取验证码
            mounted() {
                console.log('Vue实例已挂载');
                // 为验证码图片添加点击事件，点击可刷新验证码
                this.$nextTick(() => {
                    // 等待DOM更新完成
                    console.log('DOM已更新，验证码准备完成');
                });
            }
        });
    </script>

</body>

</html>